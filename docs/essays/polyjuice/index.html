<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-essays/polyjuice">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CPNK56S8G3"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-CPNK56S8G3",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Nervos CKB" href="/opensearch.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&display=swap">
<script src="/js/extra.js"></script><title data-rh="true">Technical Bits on Polyjuice | Nervos CKB</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://docs.nervos.org/img/undraw_online.svg"><meta data-rh="true" name="twitter:image" content="https://docs.nervos.org/img/undraw_online.svg"><meta data-rh="true" property="og:url" content="https://docs.nervos.org/docs/essays/polyjuice"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Technical Bits on Polyjuice | Nervos CKB"><meta data-rh="true" name="description" content="Polyjuice is an Ethereum compatible layer and has implemented most of the functions of Ethereum on CKB, including running an EVM contract on CKB-VM. We believe that we have achieved full-featured compatibility with the implementation of EVM,which is also the power of CKB-VM.By polyjuice we want to showcase that it is perfectly possible to use account model on Nervos CKB. The flexibility here actually enables countless opportunities."><meta data-rh="true" property="og:description" content="Polyjuice is an Ethereum compatible layer and has implemented most of the functions of Ethereum on CKB, including running an EVM contract on CKB-VM. We believe that we have achieved full-featured compatibility with the implementation of EVM,which is also the power of CKB-VM.By polyjuice we want to showcase that it is perfectly possible to use account model on Nervos CKB. The flexibility here actually enables countless opportunities."><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://docs.nervos.org/docs/essays/polyjuice"><link data-rh="true" rel="alternate" href="https://docs.nervos.org/docs/essays/polyjuice" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.nervos.org/docs/essays/polyjuice" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://LU9B8PQ7W5-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.88793b4f.css">
<link rel="preload" href="/assets/js/runtime~main.b62abc76.js" as="script">
<link rel="preload" href="/assets/js/main.8e1dff1b.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Nervos CKB" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Nervos CKB" class="themedImage_ToTc themedImage--dark_i4oU"></div></a><a class="navbar__item navbar__link" href="/docs/basics/introduction">Basics</a><a class="navbar__item navbar__link" href="/docs/reference/introduction">Reference</a><a class="navbar__item navbar__link" href="/docs/labs/introduction">Labs</a><a class="navbar__item navbar__link" href="/docs/integrate/introduction">Integrate</a><a class="navbar__item navbar__link" href="/docs/essays/introduction">Essays</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/basics/concepts/cell-model">basics</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/essays/ckb-core-dev">essays</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/essays/ckb-core-dev">Tips for CKB development</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/essays/debug">Tips for debugging CKB script</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/essays/dependencies">Script dependencies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/essays/developer-materials-guide">Developer Materials Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/essays/faq">CKB FAQs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/essays/integrity-check">Integrity Check for CKB Release</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/essays/introduction">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/essays/introduction-to-ckb-studio">Introduction to CKB Studio</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/essays/lifecycle">Transaction validation lifecycle</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/essays/mint-sudt-via-contract">Mint SUDT via Contract</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/essays/polyjuice">Technical Bits on Polyjuice</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/essays/pprof">Tips for profiling CKB script</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/essays/pw-lock">Introduction of PW-lock</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/essays/rfcs">A Tour of RFCs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/essays/rules">CKB VM Verification Rules</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/essays/tx-confirmation">The Back-of-Envelope Calculation of the Transaction Confirmation Number</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/essays/tx-pool">Transaction Pool</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/essays/workflow">The General Workflow for Constructing a Transaction</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/integrate/introduction">integrate</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/labs/capsule-dynamic-loading-tutorial">labs</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/reference/cell">reference</a></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">essays</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Technical Bits on Polyjuice</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Technical Bits on Polyjuice</h1></header><p><a href="https://github.com/nervosnetwork/polyjuice" target="_blank" rel="noopener noreferrer">Polyjuice</a> is an Ethereum compatible layer and has implemented most of the functions of Ethereum on CKB, including running an EVM contract on CKB-VM. We believe that we have achieved full-featured compatibility with the implementation of EVM,which is also the power of CKB-VM.By polyjuice we want to showcase that it is perfectly possible to use account model on Nervos CKB. The flexibility here actually enables countless opportunities.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="basic-concepts">Basic Concepts<a class="hash-link" href="#basic-concepts" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="account">Account<a class="hash-link" href="#account" title="Direct link to heading">​</a></h3><p>There are two kinds of accounts, contract account, and EoA account.</p><p><strong>Contract Account</strong></p><p> The contract account in Polyjuice is a cell constrained by Polyjuice type script. The type script args is a <a href="https://github.com/nervosnetwork/rfcs/blob/master/rfcs/0022-transaction-structure/0022-transaction-structure.md#type-id" target="_blank" rel="noopener noreferrer"><code>type_id</code></a> value so that the type script is unique. The first 32 bytes of the cell data is the <code>storage root</code> (sparse-merkle-tree) of the contract. The second 32 bytes of the cell data is the <code>code_hash</code> (<code>blake2b(code)</code>) of the contract. Since we want everyone to use the contract, we default the use of an always success lock script. We can also use any lock script for access control or other purposes.</p><p><strong>EoA Account</strong></p><p>The EoA account in Polyjuice is all live cells locked by default secp256k1 sighash lock script. The id of the account is the lock script args.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="contract">Contract<a class="hash-link" href="#contract" title="Direct link to heading">​</a></h3><p>A contract in Polyjuice is mostly the same as an ethereum contract. You can write your contract in Solidity, Vyper, or Assembly, then compile to EVM byte code. There are some minor differences. Since it&#x27;s <strong>impossible</strong> to read block information from the current block, we instead read block information from the most recent block. The most recent means the latest block of blocks includes the transaction inputs:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">max(block_number(inputs))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It will effect following op codes:</p><ul><li><code>BLOCKHASH</code> </li><li><code>COINBASE</code> </li><li><code>TIMESTAMP</code></li><li><code>NUMBER</code></li><li><code>DIFFICULTY</code></li><li><code>GASLIMIT</code></li></ul><p>The <code>DIFFICULTY</code> value is the difficulty of <a href="https://github.com/nervosnetwork/rfcs/blob/master/rfcs/0020-ckb-consensus-protocol/0020-ckb-consensus-protocol.md#dynamic-difficulty-adjustment-mechanism" target="_blank" rel="noopener noreferrer">Nervos CKB chain</a>. The <code>GASLIMIT</code> here is a constant value, which equals the max value of <code>int64_t </code>(9223372036854775807). The transaction cost is determined by its size and <a href="https://github.com/nervosnetwork/rfcs/blob/master/rfcs/0014-vm-cycle-limits/0014-vm-cycle-limits.md" target="_blank" rel="noopener noreferrer">cycles</a>, so gas limit is meaningless in Polyjuice.</p><p> The <code>COINBASE</code> return value and <code>SELFDESTRUCT</code> beneficiary address are the first 20 bytes of lock script hash, which is:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">blake2b(lock_script)[0..20]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="program">Program<a class="hash-link" href="#program" title="Direct link to heading">​</a></h3><p>A program is a <code>CREATE</code> or <code>CALL</code> with parameters. Since polyjuice supports contract call contract, a polyjuice transaction can contain multiple programs, which will be serialized and put into witness.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="generator">Generator<a class="hash-link" href="#generator" title="Direct link to heading">​</a></h3><p>Polyjuice generator can generate a Polyjuice transaction through JSONRPC API as below:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn create(sender: H160, code: Bytes) -&gt; TransactionReceipt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn call(sender: H160, contract_address: H160, input: Bytes) -&gt; TransactionReceipt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="validator">Validator<a class="hash-link" href="#validator" title="Direct link to heading">​</a></h3><p>Polyjuice validator is the type script that verifies the transformation of contract cells.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="indexer">Indexer<a class="hash-link" href="#indexer" title="Direct link to heading">​</a></h3><p>Indexer is a Polyjuice module for indexing every Polyjuice transaction in CKB block. The contract metadata, alteration, and all the logs emitted from the Polyjuice transaction will be saved. Also, all live cells will be indexed for running the generator (build Polyjuice transaction).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="design-details">Design Details<a class="hash-link" href="#design-details" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-organize-cells-in-a-ckb-transaction">How to organize cells in a CKB transaction?<a class="hash-link" href="#how-to-organize-cells-in-a-ckb-transaction" title="Direct link to heading">​</a></h3><img loading="lazy" src="/assets/images/polyjuice-transaction-structure-9234b8a127cfdd9fc26f7e7a9239e25a.jpg" width="600" class="img_ev3q"><p>If the picture is not clear, please click：
<strong><a href="https://github.com/TheWaWaR/polyjuice/blob/docs/docs/assets/polyjuice-transaction-structure.pdf" target="_blank" rel="noopener noreferrer">Organize cells in a CKB transaction</a></strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-ckb-transaction-generation-process">The CKB transaction generation process<a class="hash-link" href="#the-ckb-transaction-generation-process" title="Direct link to heading">​</a></h3><img loading="lazy" src="/assets/images/polyjuice-how-generator-works-1f5bc5615400ce064ec0747af04cbe33.jpg" width="600" class="img_ev3q"><p>If the picture is not clear, please click：
<strong><a href="https://github.com/TheWaWaR/polyjuice/blob/docs/docs/assets/polyjuice-how-generator-works.pdf" target="_blank" rel="noopener noreferrer">CKB transaction generation process</a></strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-ckb-transaction-validation-process">The CKB transaction validation process<a class="hash-link" href="#the-ckb-transaction-validation-process" title="Direct link to heading">​</a></h3><img loading="lazy" src="/assets/images/polyjuice-how-validator-works-665c47b8a838a156c893e9cf0f39b894.jpg" width="600" class="img_ev3q"><p>If the picture is not clear, please click：
<strong><a href="https://github.com/TheWaWaR/polyjuice/blob/docs/docs/assets/polyjuice-how-validator-works.pdf" target="_blank" rel="noopener noreferrer">CKB transaction validation process</a></strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="communicate-through-ckb-vm-syscalls">Communicate through ckb-vm syscalls<a class="hash-link" href="#communicate-through-ckb-vm-syscalls" title="Direct link to heading">​</a></h3><p>In Generator and Indexer, we use syscalls to handle the event emitted from the program execution process. The syscalls we currently used are shown below:</p><ul><li>2177 is for ckb_debug, useful when you want to debug the generator.</li><li>3075 is for returning the EVM result.</li><li>3076 is for logging.</li><li>3077 is for saving <code>SELFDESTRUCT</code> beneficiary address.</li><li>3078 is for handle CALL and CREATE opcodes.</li><li>3079 is for returning code size of a contract to EVM.</li><li>3080 is for returning a coded slice of a contract to EVM.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementation-details">Implementation Details<a class="hash-link" href="#implementation-details" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-handle-contract-creation">How to handle contract creation?<a class="hash-link" href="#how-to-handle-contract-creation" title="Direct link to heading">​</a></h3><p>A <code>CREATE</code> from a sender (EoA account) or contract will lead to contract creation. In generator,  the created cell will be assigned a type_id type script, and the contract code hash will be saved in the data field next to the account storage root hash. In validator, type script will check the contract code hash match the code_hash in the data field.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-handle-contract-destruction">How to handle contract destruction?<a class="hash-link" href="#how-to-handle-contract-destruction" title="Direct link to heading">​</a></h3><p>Contract destruction only happens when a <code>SELFDESTRUCT</code> opcode is executed. In the generator, the destructed contract cell is consumed as input, then put an output cell as the beneficiary cell, and the beneficiary address is the corresponding secp256k1 sighash lock script.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-generate-a-contract-call-contract-ckb-transaction">How to generate a contract call contract CKB transaction?<a class="hash-link" href="#how-to-generate-a-contract-call-contract-ckb-transaction" title="Direct link to heading">​</a></h3><p>When CALL or CREATE opcode is invoked in EVM, we call it a contract call contract transaction. When invoking CALL opcode, generator load contract code and latest storage from the database or saved state (the contract has already been loaded from database) by destination and execute it. When CREATE opcode executed after EVM started, the generator will put an output cell just like how contract creation works.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-validate-contract-call-contract-ckb-transaction">How to validate contract call contract CKB transaction?<a class="hash-link" href="#how-to-validate-contract-call-contract-ckb-transaction" title="Direct link to heading">​</a></h3><p>The first contract created or called by EoA account we call it <strong>entrance</strong> contract, other contracts if there is any, we call them normal contracts. Only one program is allowed in <strong>the entrance</strong> contract, and all its calls to normal contracts&#x27; programs must match the order and count. All normal contracts&#x27; calls to sub normal contracts&#x27; programs must check they match the request. Since multiple contracts may call one contract, the count can not be checked by a normal contract. Normal contracts only check their own programs, and <strong>the entrance</strong> contract will check all programs in current CKB transaction that are being called with the restricted sequence.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-verify-the-contract-sender-eoa-account">How to verify the contract sender (EoA account)?<a class="hash-link" href="#how-to-verify-the-contract-sender-eoa-account" title="Direct link to heading">​</a></h3><p>Since EVM execution will use the sender information, we require the sender to sign the Polyjuice transaction and put the signature into witness. The sign content must include two parts:</p><ol><li>transaction hash  </li><li>all contracts&#x27; related witnesses </li></ol><p>The contract-related witness is serialized as part of the <code>WitnessArgs</code> molecule structure, and the information is located in input_type (contract call/destruction) field or output_type (contract creation) field.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-handle-logs">How to handle logs?<a class="hash-link" href="#how-to-handle-logs" title="Direct link to heading">​</a></h3><p>In validator, the logs are just being ignored. When the generator generates the Polyjuice transaction, the logs are saved and returned as part of the transaction receipt. When the Indexer processes the Polyjuice transaction, the logs are saved to the database for users to query.</p><p> In generator and Indexer the logs are trigged by LOG opcode, then:</p><ol><li>callback function <code>emit_log</code> is called</li><li>emit_log invoke a log syscall with topics and data as arguments</li><li>Rust syscall handler function is called, the arguments been extracted and saved</li></ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/nervosnetwork/docs-new/tree/develop/website/docs/essays/polyjuice.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/essays/mint-sudt-via-contract"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Mint SUDT via Contract</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/essays/pprof"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Tips for profiling CKB script</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#basic-concepts" class="table-of-contents__link toc-highlight">Basic Concepts</a><ul><li><a href="#account" class="table-of-contents__link toc-highlight">Account</a></li><li><a href="#contract" class="table-of-contents__link toc-highlight">Contract</a></li><li><a href="#program" class="table-of-contents__link toc-highlight">Program</a></li><li><a href="#generator" class="table-of-contents__link toc-highlight">Generator</a></li><li><a href="#validator" class="table-of-contents__link toc-highlight">Validator</a></li><li><a href="#indexer" class="table-of-contents__link toc-highlight">Indexer</a></li></ul></li><li><a href="#design-details" class="table-of-contents__link toc-highlight">Design Details</a><ul><li><a href="#how-to-organize-cells-in-a-ckb-transaction" class="table-of-contents__link toc-highlight">How to organize cells in a CKB transaction?</a></li><li><a href="#the-ckb-transaction-generation-process" class="table-of-contents__link toc-highlight">The CKB transaction generation process</a></li><li><a href="#the-ckb-transaction-validation-process" class="table-of-contents__link toc-highlight">The CKB transaction validation process</a></li><li><a href="#communicate-through-ckb-vm-syscalls" class="table-of-contents__link toc-highlight">Communicate through ckb-vm syscalls</a></li></ul></li><li><a href="#implementation-details" class="table-of-contents__link toc-highlight">Implementation Details</a><ul><li><a href="#how-to-handle-contract-creation" class="table-of-contents__link toc-highlight">How to handle contract creation?</a></li><li><a href="#how-to-handle-contract-destruction" class="table-of-contents__link toc-highlight">How to handle contract destruction?</a></li><li><a href="#how-to-generate-a-contract-call-contract-ckb-transaction" class="table-of-contents__link toc-highlight">How to generate a contract call contract CKB transaction?</a></li><li><a href="#how-to-validate-contract-call-contract-ckb-transaction" class="table-of-contents__link toc-highlight">How to validate contract call contract CKB transaction?</a></li><li><a href="#how-to-verify-the-contract-sender-eoa-account" class="table-of-contents__link toc-highlight">How to verify the contract sender (EoA account)?</a></li><li><a href="#how-to-handle-logs" class="table-of-contents__link toc-highlight">How to handle logs?</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Foundation</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.nervos.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">About Us</a></li></ul></div><div class="col footer__col"><div class="footer__title">Developer</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/nervosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://github.com/nervosnetwork/rfcs/blob/master/rfcs/0002-ckb/0002-ckb.md" target="_blank" rel="noopener noreferrer" class="footer__link-item">Whitepaper</a></li><li class="footer__item"><a href="https://github.com/nervosnetwork/rfcs" target="_blank" rel="noopener noreferrer" class="footer__link-item">RFCs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/AqGTUE9" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://talk.nervos.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum</a></li><li class="footer__item"><a href="https://www.reddit.com/r/NervosNetwork/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Reddit</a></li><li class="footer__item"><a href="https://t.me/nervosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/nervosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://medium.com/nervosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Medium</a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCONuJGdMzUY0Y6jrPBOzH7A" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021  Nervos Foundation. All Rights Reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b62abc76.js"></script>
<script src="/assets/js/main.8e1dff1b.js"></script>
</body>
</html>